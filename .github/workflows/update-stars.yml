name: Update Recently Starred

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch:

jobs:
  update-stars:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch starred repos
        id: stars
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const username = process.env.GITHUB_ACTOR;
            const query = `
            query ($login: String!, $first: Int!) {
              user(login: $login) {
                starredRepositories(first: $first, orderBy: {field: STARRED_AT, direction: DESC}) {
                  edges {
                    starredAt
                    node {
                      name
                      url
                      stargazerCount
                      description
                    }
                  }
                }
              }
            }`;
            const variables = {
              login: username,
              first: 10
            };

            const response = await github.graphql(query, variables);

            const stars = response.user.starredRepositories.edges
              .map(e => e.node)
              .map(r => `- [${r.name}](${r.url}) — ⭐ ${r.stargazerCount}`)
              .join("\n");
            return stars;

      - name: Update README
        run: |
          README=README.md
          START="<!-- RECENT_STARS:START -->"
          END="<!-- RECENT_STARS:END -->"
          STAR_CONTENT="${{ steps.stars.outputs.result }}"
          # write the section
          awk -v start="$START" -v end="$END" -v repl="$STAR_CONTENT" '
            $0 ~ start{print; print repl; skip=1; next}
            $0 ~ end{skip=0}
            skip{next}
            {print}
          ' $README > tmp && mv tmp $README

      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update recent stars"
          push_options: "--force"
          file_pattern: README.md
