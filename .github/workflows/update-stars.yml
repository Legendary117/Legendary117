name: Update Recently Starred

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update-stars:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch starred repos
        id: stars
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const username = "Legendary117";

            const query = `
            query ($login: String!, $first: Int!) {
              user(login: $login) {
                starredRepositories(
                  first: $first
                  orderBy: { field: STARRED_AT, direction: DESC }
                ) {
                  edges {
                    node {
                      name
                      url
                      description
                    }
                  }
                }
              }
            }`;

            const response = await github.graphql(query, {
              login: username,
              first: 10
            });

            const stars = response.user.starredRepositories.edges
              .map(({ node }) => {
                const desc = node.description
                  ? ` â€” ${node.description.replace(/\n/g, " ")}`
                  : "";
                return `- [${node.name}](${node.url})${desc}`;
              })
              .join("\n");

            return stars;

      - name: Update README
        run: |
          README=README.md
          START="<!-- RECENT_STARS:START -->"
          END="<!-- RECENT_STARS:END -->"
          CONTENT="${{ steps.stars.outputs.result }}"

          awk -v start="$START" -v end="$END" -v repl="$CONTENT" '
            $0 ~ start { print; print repl; skip=1; next }
            $0 ~ end { skip=0 }
            skip { next }
            { print }
          ' "$README" > tmp && mv tmp "$README"

      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update recent stars"
          file_pattern: README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
